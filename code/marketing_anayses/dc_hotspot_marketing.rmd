---
title: "Title"
subtitle: "Subtitle"
author: "Name"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: TRUE
    toc_float:
      collapsed: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  cache = FALSE, cache.lazy = FALSE, autodep = TRUE, warning = FALSE, 
  message = FALSE, echo = TRUE, dpi = 180,
  fig.width = 8, fig.height = 5, echo = FALSE
  )
```

<!--#general comments===========================================================
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#
# This is [[insert description here - what it does/solve]]
#
# By: mike gaunt, michael.gaunt@wsp.com
#
# README: [[insert brief readme here]]
#-------- [[insert brief readme here]]
#
# *please use 80 character margins
# *please go to https://pkgs.rstudio.com/flexdashboard/articles/layouts.html
# to explore the different layouts available for the flexdashboard framework
#
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

<!--#library set-up=============================================================
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#content in this section should be removed if in production - ok for dev -->
```{r}
library(here)
library(tidyverse)

library(leaflet)
library(leaflet.extras2)
library(mapview)
library(sf)

library(SpatialKDE)
library(sfhotspot)

```

<!--#source helpers/utilities===================================================
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#content in this section should be removed if in production - ok for dev -->
```{r}

```

<!--#source data================================================================
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#content in this section should be removed if in production - ok for dev 
#area to upload data with and to perform initial munging
#please add test data here so that others may use/unit test these scripts -->

```{r}
location = "data/req_dev"
folder = 'data_20230117_092037'

crs  = 32610
```


```{r}
bb_sa_layer = read_sf(here(location, 'study_area_network.shp'))

replica_trip_origin_links_file = here(location, folder, "replica_trip_origin_links.gpkg")
replica_trip_origin_links = read_sf(replica_trip_origin_links_file)

replica_trip_origin_links_fltrd = replica_trip_origin_links %>%  
  st_filter(bb_sa_layer) %>%  
  st_transform(crs = 32610)
```
 


<!--#SECTION NAME===============================================================
#use this header to make demarcations/section in code [delete this line]
#short description -->

# Header

## Intro 

This document is a case study of how the data acquired from the Replica data platform was used to perfrom a freight analysis in the DC area. 

Work Summary 

+ point 1
+ point 2
  - `point2.1`
  - point2.2
+ point 2

Work Outcomes 

+ point 1
+ point 2
  - `point2.1`
  - point2.2
+ point 2

## Analysis Workflow

### Required Data Input 

Replica data projects require two specific GIS polygons in order to query the data. 

The first required polygon is the **Network Boundary Polygon**. This polygon layer serves two roles, first, it defines the extent of the network that is queried. Any network link within this boundary will be queried and obtained for the purposes of said analysis. Second, the the network is used to query trips within the region, any trip that travels on at least one of the links that fall within this extent will be queried. 

The below map was used to define the extent of the network query. It is a collection of block groups in Rhode Island.

```{r}
mapview(bb_sa_layer)
```

**Note:** Again, trips originating or terminating outside of this poly will be queried and included in network volumes

The second required polygon is the **Study Area Polygon**, this layer defines which polygons (blockgroups or TAZs) are within the analysis's study area. These polys are assigned an _internal_ designation and and polys outside this poly will be assigned as _external_. These designations help focus the analysis and are used to determine the trip 

While trips terminating or originating in _extneral_
Polygons outside the study area polygon will be considered “external” and lumped together for simplicity 
NOTE: trips from or to external polygons will still be accounted for in OD diagrams or on network links
which can be the same as the _Network Boundary Polygon_

### Queryied Data

```{r}
# replica_trip_origin_links_fltrd %>%  
#   sample_n(1000) %>%  
#   mapview()
```


```{r}
# grid_sm = create_grid_hexagonal(replica_trip_origin_links_fltrd,
#                                 cell_size = 200) 
# 
# grid_sm_water_removed = tigris::erase_water(grid_sm) %>%  
#   st_cast("POLYGON")
```


```{r}
# grid_sm_water_removed_4326 = grid_sm_water_removed %>%  st_transform(4326)
# grid_sm_water_removed %>%  
#   mapview()
# 
# grid_sm %>% 
#   st_transform(4326) %>% 
#   leaflet() %>%  
#   addMapPane("left", zIndex = 0) %>%
#   addMapPane("right", zIndex = 0) %>%
#   addTiles(group = "base", layerId = "baseid",
#            options = pathOptions(pane = "right")) %>%
#   addProviderTiles(providers$OpenStreetMap, group="carto", layerId = "cartoid",
#                    options = pathOptions(pane = "left")) %>%
#   addPolygons(weight = 1, options = pathOptions(pane = "left")) %>%  
#   addPolygons(data = grid_sm_water_removed_4326, weight = 1, options = pathOptions(pane = "right")) %>%
#   addSidebyside(layerId = "sidecontrols",
#                 rightId = "baseid",
#                 leftId = "baseid")
```

```{r}
# hotspot_obeject = list(
#   list("MEDIUM_COMMERCIAL", "MEDIUM_COMMERCIAL", "HEAVY_COMMERCIAL", "HEAVY_COMMERCIAL")
#   ,list(grid_sm_water_removed, grid_sm, grid_sm_water_removed, grid_sm)
# ) %>%  
#   pmap(~{
#     temp_hotspot = replica_trip_origin_links_fltrd %>%  
#       filter(vehicle_type == .x) %>% 
#       hotspot_kde(
#         data = .
#         ,grid = .y
#         ,weights = count 
#         ,bandwidth = 800) %>%  
#       mutate(kde_norm = gauntlet::normalize_min_max(kde)) %>% 
#       mutate(label = str_glue("KDE (Min-Max Norm): {dgt2(kde_norm)}<br>KDE (raw): {dgt2(kde)}<br>Sum: {sum}")) %>%
#       st_transform(crs = 4326)
#   })
```

```{r}

# (hotspot_obeject[[3]] %>%  mapview(layer.name  = "rm")) +
# (hotspot_obeject[[1]] %>%  mapview(layer.name  = "raw"))
# # mapview::sync()
# 
# 
# pal_rm <- colorNumeric(
#   palette = "magma",
#   domain = hotspot_obeject[[3]]$kde_norm)
# 
# pal_nrm <- colorNumeric(
#   palette = "magma",
#   domain = hotspot_obeject[[1]]$kde_norm)
# 
# leaflet() %>% 
#   addMapPane("left", zIndex = 0) %>%
#   addMapPane("right", zIndex = 0) %>%
#   addTiles(group = "base", layerId = "baseid",
#            options = pathOptions(pane = "right")) %>%
#   addProviderTiles(providers$OpenStreetMap, group="carto", layerId = "cartoid",
#                    options = pathOptions(pane = "left")) %>%
#   addPolygons(data = hotspot_obeject[[3]], weight = 1#, fillOpacity = 1
#               ,color  = ~pal_rm(hotspot_obeject[[3]]$kde_norm), options = pathOptions(pane = "left")
#               ,label = hotspot_obeject[[3]]$label %>%
#                     map(htmltools::HTML)) %>%  
#   addPolygons(data = hotspot_obeject[[1]], weight = 1
#               ,color  = ~pal_nrm(hotspot_obeject[[1]]$kde_norm), options = pathOptions(pane = "right")
#               ,label = hotspot_obeject[[1]]$label %>%
#                     map(htmltools::HTML)) %>% 
#   addSidebyside(layerId = "sidecontrols",
#                 rightId = "baseid",
#                 leftId = "baseid")
```

```{r}
# hotspot_obeject[[3]] %>%  
#   st_centroid() %>%  
#   gauntlet::st_extract_coords() %>%  
#   st_drop_geometry() %>% 
#   select(!c(sum, label)) %>% 
#   dbscan::hdbscan(minPts = 5) %>% 
#   mutate(coor gauntlet::st_extract_coords())
```



#### Header

<details>
<summary>Click to Expand</summary>

Example of expandable box. 

```{r}
# Sys.Date()
```

</details>      

Example of inline code: ``r Sys.Date()``       

Example of flex displays. 

:::: {style="display: flex;"}

::: {}

```{r fig.height = 2, fig.width=4}
# plot(mtcars[,c(1:3)])
```

:::

::: {}

```{r fig.height = 2}
# plot(mtcars[,c(4:6)])
```

:::

::::

### {-}

### Section 

+ point 1
+ point 2
  - `point2.1`
  - point2.2
+ point 2


### Tab {.tabset}

#### Tab 1

#### Tab 2

### {-}



<!--end-->






