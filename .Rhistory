addMapPane("right", zIndex = 0) %>%
addTiles(group = "base", layerId = "baseid",
options = pathOptions(pane = "right")) %>%
addProviderTiles(providers$OpenStreetMap, group="carto", layerId = "cartoid",
options = pathOptions(pane = "left")) %>%
addPolygons(data = hotspot_obeject[[2]], weight = 1#, fillOpacity = 1
,color  = ~pal_rm(hotspot_obeject[[2]]$kde_norm), options = pathOptions(pane = "left")
,label = hotspot_obeject[[2]]$label %>%
map(htmltools::HTML)) %>%
addPolygons(data = hotspot_obeject[[1]], weight = 1
,color  = ~pal_nrm(hotspot_obeject[[1]]$kde_norm), options = pathOptions(pane = "right")
,label = hotspot_obeject[[1]]$label %>%
map(htmltools::HTML)) %>%
addSidebyside(layerId = "sidecontrols",
rightId = "baseid",
leftId = "baseid")
hotspot_obeject[[2]] %>%  mapview()
hotspot_obeject[[1]] %>%  mapview()
(hotspot_obeject[[2]] %>%  mapview()) +
(hotspot_obeject[[1]] %>%  mapview())
(hotspot_obeject[[2]] %>%  mapview(label = "rm")) +
(hotspot_obeject[[1]] %>%  mapview(label = "raw"))
(hotspot_obeject[[2]] %>%  mapview(legend  = "rm")) +
(hotspot_obeject[[1]] %>%  mapview(legend  = "raw"))
hotspot_obeject[[2]] %>%  mapview(legend  = "rm")
(hotspot_obeject[[2]] %>%  mapview(layer.name  = "rm")) +
(hotspot_obeject[[1]] %>%  mapview(layer.name  = "raw"))
hotspot_obeject[[1]] %>%  mapview(layer.name  = "raw")
# (hotspot_obeject[[3]] %>%  mapview(layer.name  = "rm")) +
# (hotspot_obeject[[1]] %>%  mapview(layer.name  = "raw"))
# mapview::sync()
pal_rm <- colorNumeric(
palette = "magma",
domain = hotspot_obeject[[3]]$kde_norm)
pal_nrm <- colorNumeric(
palette = "magma",
domain = hotspot_obeject[[1]]$kde_norm)
leaflet() %>%
# addMapPane("left", zIndex = 0) %>%
# addMapPane("right", zIndex = 0) %>%
addTiles(group = "base", layerId = "baseid",
options = pathOptions(pane = "right")) %>%
addProviderTiles(providers$OpenStreetMap, group="carto", layerId = "cartoid",
options = pathOptions(pane = "left")) %>%
addPolygons(data = hotspot_obeject[[3]], weight = 1#, fillOpacity = 1
,color  = ~pal_rm(hotspot_obeject[[3]]$kde_norm), options = pathOptions(pane = "left")
,label = hotspot_obeject[[3]]$label %>%
map(htmltools::HTML)) %>%
addPolygons(data = hotspot_obeject[[1]], weight = 1
,color  = ~pal_nrm(hotspot_obeject[[1]]$kde_norm), options = pathOptions(pane = "right")
,label = hotspot_obeject[[1]]$label %>%
map(htmltools::HTML)) %>%
addSidebyside(layerId = "sidecontrols",
rightId = "baseid",
leftId = "baseid")
leaflet() %>%
addMapPane("left", zIndex = 0) %>%
addMapPane("right", zIndex = 0) %>%
addTiles(group = "base", layerId = "baseid",
options = pathOptions(pane = "right")) %>%
addProviderTiles(providers$OpenStreetMap, group="carto", layerId = "cartoid",
options = pathOptions(pane = "left")) %>%
addPolygons(data = hotspot_obeject[[3]], weight = 1#, fillOpacity = 1
,color  = ~pal_rm(hotspot_obeject[[3]]$kde_norm), options = pathOptions(pane = "left")
,label = hotspot_obeject[[3]]$label %>%
map(htmltools::HTML)) %>%
addPolygons(data = hotspot_obeject[[1]], weight = 1
,color  = ~pal_nrm(hotspot_obeject[[1]]$kde_norm), options = pathOptions(pane = "right")
,label = hotspot_obeject[[1]]$label %>%
map(htmltools::HTML)) %>%
addSidebyside(layerId = "sidecontrols",
rightId = "baseid",
leftId = "baseid")
hotspot_obeject[[3]]
hotspot_obeject[[3]] %>%
gauntlet::st_extract_coords()
hotspot_obeject[[3]]
hotspot_obeject[[3]] %>%
sf_centroid()
hotspot_obeject[[3]] %>%
st_centroid()
hotspot_obeject[[3]] %>%
st_centroid() %>%
gauntlet::st_extract_coords()
hotspot_obeject[[3]] %>%
st_centroid() %>%
gauntlet::st_extract_coords() %>%
dbscan::hdbscan()
hotspot_obeject[[3]] %>%
st_centroid() %>%
gauntlet::st_extract_coords()
hotspot_obeject[[3]] %>%
st_centroid() %>%
gauntlet::st_extract_coords() %>%
st_drop_geometry()
hotspot_obeject[[3]] %>%
st_centroid() %>%
gauntlet::st_extract_coords() %>%
st_drop_geometry() %>%
select(!c(sum, label))
hotspot_obeject[[3]] %>%
st_centroid() %>%
gauntlet::st_extract_coords() %>%
st_drop_geometry() %>%
select(!c(sum, label)) %>%
dbscan::hdbscan()
hotspot_obeject[[3]] %>%
st_centroid() %>%
gauntlet::st_extract_coords() %>%
st_drop_geometry() %>%
select(!c(sum, label))
hotspot_obeject[[3]] %>%
st_centroid() %>%
gauntlet::st_extract_coords() %>%
st_drop_geometry() %>%
select(!c(sum, label)) %>%
dbscan::hdbscan(minPts = 5)
temp_hotspot = replica_trip_origin_links_fltrd %>%
filter(vehicle_type == .x) %>%
hotspot_kde(
data = .
,grid = .y
,weights = count
,bandwidth = 800) %>%
mutate(kde_norm = gauntlet::normalize_min_max(kde)) %>%
mutate(label = str_glue("KDE (Min-Max Norm): {dgt2(kde_norm)}<br>KDE (raw): {dgt2(kde)}<br>Count: {n}<br>Sum: {sum}")) %>%
st_transform(crs = 4326)
hotspot_obeject
hotspot_obeject[[3]] %>%  mapview(layer.name  = "rm")
hotspot_obeject[[1]] %>%  mapview(layer.name  = "raw")
pal_rm <- colorNumeric(
palette = "magma",
domain = hotspot_obeject[[3]]$kde_norm)
pal_nrm <- colorNumeric(
palette = "magma",
domain = hotspot_obeject[[1]]$kde_norm)
leaflet() %>%
addMapPane("left", zIndex = 0) %>%
addMapPane("right", zIndex = 0) %>%
addTiles(group = "base", layerId = "baseid",
options = pathOptions(pane = "right")) %>%
addProviderTiles(providers$OpenStreetMap, group="carto", layerId = "cartoid",
options = pathOptions(pane = "left")) %>%
addPolygons(data = hotspot_obeject[[3]], weight = 1#, fillOpacity = 1
,color  = ~pal_rm(hotspot_obeject[[3]]$kde_norm), options = pathOptions(pane = "left")
,label = hotspot_obeject[[3]]$label %>%
map(htmltools::HTML)) %>%
addPolygons(data = hotspot_obeject[[1]], weight = 1
,color  = ~pal_nrm(hotspot_obeject[[1]]$kde_norm), options = pathOptions(pane = "right")
,label = hotspot_obeject[[1]]$label %>%
map(htmltools::HTML)) %>%
addSidebyside(layerId = "sidecontrols",
rightId = "baseid",
leftId = "baseid")
hotspot_obeject = list(
list("MEDIUM_COMMERCIAL", "MEDIUM_COMMERCIAL", "HEAVY_COMMERCIAL", "HEAVY_COMMERCIAL")
,list(grid_sm_water_removed, grid_sm, grid_sm_water_removed, grid_sm)
) %>%
pmap(~{
temp_hotspot = replica_trip_origin_links_fltrd %>%
filter(vehicle_type == .x) %>%
hotspot_kde(
data = .
,grid = .y
,weights = count
,bandwidth = 800) %>%
mutate(kde_norm = gauntlet::normalize_min_max(kde)) %>%
mutate(label = str_glue("KDE (Min-Max Norm): {dgt2(kde_norm)}<br>KDE (raw): {dgt2(kde)}<br>TTL Trips: {sum}")) %>%
st_transform(crs = 4326)
})
pal_rm <- colorNumeric(
palette = "magma",
domain = hotspot_obeject[[3]]$kde_norm)
pal_nrm <- colorNumeric(
palette = "magma",
domain = hotspot_obeject[[1]]$kde_norm)
leaflet() %>%
addMapPane("left", zIndex = 0) %>%
addMapPane("right", zIndex = 0) %>%
addTiles(group = "base", layerId = "baseid",
options = pathOptions(pane = "right")) %>%
addProviderTiles(providers$OpenStreetMap, group="carto", layerId = "cartoid",
options = pathOptions(pane = "left")) %>%
addPolygons(data = hotspot_obeject[[3]], weight = 1#, fillOpacity = 1
,color  = ~pal_rm(hotspot_obeject[[3]]$kde_norm), options = pathOptions(pane = "left")
,label = hotspot_obeject[[3]]$label %>%
map(htmltools::HTML)) %>%
addPolygons(data = hotspot_obeject[[1]], weight = 1
,color  = ~pal_nrm(hotspot_obeject[[1]]$kde_norm), options = pathOptions(pane = "right")
,label = hotspot_obeject[[1]]$label %>%
map(htmltools::HTML)) %>%
addSidebyside(layerId = "sidecontrols",
rightId = "baseid",
leftId = "baseid")
replica_trip_origin_links_fltrd %>%
filter(vehicle_type == "MEDIUM_COMMERCIAL") %>%
hotspot_gistar(
data = .
,grid = .y
,weights = count
,bandwidth = 800)
replica_trip_origin_links_fltrd %>%
filter(vehicle_type == "MEDIUM_COMMERCIAL") %>%
hotspot_gistar(
data = .
,grid = grid_sm_water_removed
,weights = count
,bandwidth = 800)
temp_hotspot = replica_trip_origin_links_fltrd %>%
filter(vehicle_type == "MEDIUM_COMMERCIAL") %>%
hotspot_gistar(
data = .
,grid = grid_sm_water_removed
,weights = count
,bandwidth = 800)
temp_hotspot %>%
filter(#gistar < 0
pvalue <= .01) %>%
mapview()
temp_hotspot %>%
filter(gistar < 0
pvalue <= .01) %>%
mapview()
temp_hotspot %>%
filter(gistar < 0
,pvalue <= .01) %>%
mapview()
temp_hotspot %>%
filter(gistar < 0
,pvalue <= .01)
temp_hotspot %>%
filter(gistar > 0
,pvalue <= .01) %>%
mapview()
temp_hotspot %>%
filter(gistar > 0
,pvalue <= .01) %>%
mutate(flag_gistar = case_when(gistar > 0~"Hot", T~"Cold"))
temp_hotspot %>%
filter(gistar > 0
,pvalue <= .01) %>%
mutate(flag_gistar = case_when(gistar > 0~"Hot", T~"Cold")) %>%
mapview(zcol = "flag_gistar")
temp_hotspot %>%
filter(pvalue <= .01) %>%
mutate(flag_gistar = case_when(gistar > 0~"Hot", T~"Cold")) %>%
mapview(zcol = "flag_gistar")
mapview(bb_sa_layer)
replica_trip_origin_links_fltrd %>%
sample_n(1000) %>%
mapview()
replica_trip_origin_links_fltrd %>%
sample_n(1000) %>%
mapview()
grid_sm_water_removed_4326 = grid_sm_water_removed %>%  st_transform(4326)
grid_sm %>%
st_transform(4326) %>%
leaflet() %>%
addMapPane("left", zIndex = 0) %>%
addMapPane("right", zIndex = 0) %>%
addTiles(group = "base", layerId = "baseid",
options = pathOptions(pane = "right")) %>%
addProviderTiles(providers$OpenStreetMap, group="carto", layerId = "cartoid",
options = pathOptions(pane = "left")) %>%
addPolygons(weight = 1, options = pathOptions(pane = "left")) %>%
addPolygons(data = grid_sm_water_removed_4326, weight = 1, options = pathOptions(pane = "right")) %>%
addSidebyside(layerId = "sidecontrols",
rightId = "baseid",
leftId = "baseid")
pal_rm <- colorNumeric(
palette = "magma",
domain = hotspot_obeject[[3]]$kde_norm)
pal_nrm <- colorNumeric(
palette = "magma",
domain = hotspot_obeject[[1]]$kde_norm)
leaflet() %>%
addMapPane("left", zIndex = 0) %>%
addMapPane("right", zIndex = 0) %>%
addTiles(group = "base", layerId = "baseid",
options = pathOptions(pane = "right")) %>%
addProviderTiles(providers$OpenStreetMap, group="carto", layerId = "cartoid",
options = pathOptions(pane = "left")) %>%
addPolygons(data = hotspot_obeject[[3]], weight = 1#, fillOpacity = 1
,color  = ~pal_rm(hotspot_obeject[[3]]$kde_norm), options = pathOptions(pane = "left")
,label = hotspot_obeject[[3]]$label %>%
map(htmltools::HTML)) %>%
addPolygons(data = hotspot_obeject[[1]], weight = 1
,color  = ~pal_nrm(hotspot_obeject[[1]]$kde_norm), options = pathOptions(pane = "right")
,label = hotspot_obeject[[1]]$label %>%
map(htmltools::HTML)) %>%
addSidebyside(layerId = "sidecontrols",
rightId = "baseid",
leftId = "baseid")
temp_hotspot = replica_trip_origin_links_fltrd %>%
filter(vehicle_type == "MEDIUM_COMMERCIAL") %>%
hotspot_gistar(
data = .
,grid = grid_sm_water_removed
,weights = count
,bandwidth = 800)
temp_hotspot %>%
filter(pvalue <= .01) %>%
mutate(flag_gistar = case_when(gistar > 0~"Hot", T~"Cold")) %>%
mapview(zcol = "flag_gistar")
temp_hotspot %>%
filter(pvalue <= .01) %>%
mutate(flag_gistar = case_when(gistar > 0~"Hot", T~"Cold")) %>%
mapview(layer.name = "Hotspots", zcol = "flag_gistar")
bb_sa_layer = read_sf(here(location, 'study_area_network.shp'))
replica_trip_origin_links_file = here(location, folder, "replica_trip_origin_links.gpkg")
replica_trip_origin_links = read_sf(replica_trip_origin_links_file)
replica_trip_origin_links_fltrd = replica_trip_origin_links %>%
st_filter(bb_sa_layer) %>%
st_transform(crs = 32610)
library(here)
library(tidyverse)
library(leaflet)
library(leaflet.extras2)
library(mapview)
library(sf)
library(SpatialKDE)
library(sfhotspot)
location = "data/req_dev"
folder = 'data_20230117_092037'
crs  = 32610
bb_sa_layer = read_sf(here(location, 'study_area_network.shp'))
replica_trip_origin_links_file = here(location, folder, "replica_trip_origin_links.gpkg")
replica_trip_origin_links = read_sf(replica_trip_origin_links_file)
replica_trip_origin_links_fltrd = replica_trip_origin_links %>%
st_filter(bb_sa_layer) %>%
st_transform(crs = 32610)
mapview(bb_sa_layer)
replica_trip_origin_links_fltrd %>%
sample_n(1000) %>%
mapview()
grid_sm = create_grid_hexagonal(
replica_trip_origin_links_fltrd
,cell_size = 200)
grid_sm_water_removed = tigris::erase_water(grid_sm) %>%
st_cast("POLYGON")
grid_sm_water_removed_4326 = grid_sm_water_removed %>%  st_transform(4326)
grid_sm %>%
st_transform(4326) %>%
leaflet() %>%
addMapPane("left", zIndex = 0) %>%
addMapPane("right", zIndex = 0) %>%
addTiles(group = "base", layerId = "baseid",
options = pathOptions(pane = "right")) %>%
addProviderTiles(providers$OpenStreetMap, group="carto", layerId = "cartoid",
options = pathOptions(pane = "left")) %>%
addPolygons(weight = 1, options = pathOptions(pane = "left")) %>%
addPolygons(data = grid_sm_water_removed_4326, weight = 1, options = pathOptions(pane = "right")) %>%
addSidebyside(layerId = "sidecontrols",
rightId = "baseid",
leftId = "baseid")
hotspot_obeject = list(
list("MEDIUM_COMMERCIAL", "MEDIUM_COMMERCIAL", "HEAVY_COMMERCIAL", "HEAVY_COMMERCIAL")
,list(grid_sm_water_removed, grid_sm, grid_sm_water_removed, grid_sm)
) %>%
pmap(~{
temp_hotspot = replica_trip_origin_links_fltrd %>%
filter(vehicle_type == .x) %>%
hotspot_kde(
data = .
,grid = .y
,weights = count
,bandwidth = 800) %>%
mutate(kde_norm = gauntlet::normalize_min_max(kde)) %>%
mutate(label = str_glue("KDE (Min-Max Norm): {dgt2(kde_norm)}<br>KDE (raw): {dgt2(kde)}<br>TTL Trips: {sum}")) %>%
st_transform(crs = 4326)
})
pal_rm <- colorNumeric(
palette = "magma",
domain = hotspot_obeject[[3]]$kde_norm)
pal_nrm <- colorNumeric(
palette = "magma",
domain = hotspot_obeject[[1]]$kde_norm)
leaflet() %>%
addMapPane("left", zIndex = 0) %>%
addMapPane("right", zIndex = 0) %>%
addTiles(group = "base", layerId = "baseid",
options = pathOptions(pane = "right")) %>%
addProviderTiles(providers$OpenStreetMap, group="carto", layerId = "cartoid",
options = pathOptions(pane = "left")) %>%
addPolygons(data = hotspot_obeject[[3]], weight = 1#, fillOpacity = 1
,color  = ~pal_rm(hotspot_obeject[[3]]$kde_norm), options = pathOptions(pane = "left")
,label = hotspot_obeject[[3]]$label %>%
map(htmltools::HTML)) %>%
addPolygons(data = hotspot_obeject[[1]], weight = 1
,color  = ~pal_nrm(hotspot_obeject[[1]]$kde_norm), options = pathOptions(pane = "right")
,label = hotspot_obeject[[1]]$label %>%
map(htmltools::HTML)) %>%
addSidebyside(layerId = "sidecontrols",
rightId = "baseid",
leftId = "baseid")
temp_hotspot = replica_trip_origin_links_fltrd %>%
filter(vehicle_type == "MEDIUM_COMMERCIAL") %>%
hotspot_gistar(
data = .
,grid = grid_sm_water_removed
,weights = count
,bandwidth = 800)
temp_hotspot %>%
filter(pvalue <= .01) %>%
mutate(flag_gistar = case_when(gistar > 0~"Hot", T~"Cold")) %>%
mapview(layer.name = "Hotspots", zcol = "flag_gistar")
library(replicaToolkitR)
data("study_area_polys")
study_area_polys
data("study_area_network")
data("study_area_polys")
# data("study_area_network")
head(study_area_polys)
location = "data/req_dev"
folder = 'data_20230117_092037'
study_area_network = here('data/req_dev/study_area_network.shp')
study_area_network = here(location, 'study_area_network.shp')
study_area_network
study_area_network = here(location, 'study_area_network.shp') %>%  read_sf() %>%  st_transform(crs = 4326)
study_area_network
usethis::use_data(study_area_network)
here(location, 'study_area_network') %>%  paste0(".shp")
poi_list = here(location, 'poi_list') %>%
paste0(".csv") %>%  read_sf() %>%  st_transform(crs = 4326)
usethis::use_data(poi_list)
poi_list = here(location, 'poi_list') %>%
paste0(".csv") %>%  read.csv()
here(location, 'poi_list') %>%
paste0(".csv")
poi_list = here(location, 'poi_list') %>%
paste0(".csv") %>%  read.csv()
usethis::use_data(poi_list)
replica_queried_network = here(location, folder, 'replica_queried_network') %>%
paste0(".csv") %>%  read.csv()
usethis::use_data(replica_queried_network)
eplica_queried_network = here(location, folder, 'replica_queried_network') %>%
paste0(".csv") %>%  read.csv()
usethis::use_data(replica_queried_network)
replica_sa_poly_index = here(location, folder, 'replica_sa_poly_index') %>%
paste0(".csv") %>%  read.csv()
usethis::use_data(replica_sa_poly_index)
replica_trip_origin_destination = here(location, folder, 'replica_trip_origin_destination') %>%
paste0(".csv") %>%  read.csv()
usethis::use_data(replica_trip_origin_destination)
replica_trip_origin_links = here(location, folder, 'replica_trip_origin_links') %>%
paste0(".csv") %>%  read.csv()
usethis::use_data(replica_trip_origin_links)
table_agg_by_link_subset_limited = here(location, folder, 'table_agg_by_link_subset_limited') %>%
paste0(".csv") %>%  read.csv()
usethis::use_data(table_agg_by_link_subset_limited)
replica_trip_origin_links = here(location, folder, 'replica_trip_origin_links') %>%
paste0(".gpkg") %>%  read_sf() %>%  st_transform(crs = 4326)
usethis::use_data(replica_trip_origin_links)
acquired_sa_polys = here(location, folder, 'acquired_sa_polys') %>%
paste0(".gpkg") %>%  read_sf() %>%  st_transform(crs = 4326)
usethis::use_data(acquired_sa_polys)
aggregated_network_links = here(location, folder, 'aggregated_network_links') %>%
paste0(".rds") %>%  read_sf() %>%  st_transform(crs = 4326)
usethis::use_data(aggregated_network_links)
replica_queried_network = here(location, folder, 'replica_queried_network') %>%
paste0(".csv") %>%  read.csv()
usethis::use_data(replica_queried_network, overwrite = TRUE)
aggregated_network_links = here(location, folder, 'aggregated_network_links') %>%
paste0(".rds")
usethis::use_data(aggregated_network_links, overwrite = TRUE)
library(replicaToolkitR)
data("replica_trip_origin_links")
replica_trip_origin_links
replica_trip_origin_links_fltrd = replica_trip_origin_links %>%
st_as_sf(coords = c("startLon", "startLat")) %>%
st_filter(bb_sa_layer) %>%
st_transform(crs = 32610)
replica_trip_origin_links_fltrd = replica_trip_origin_links %>%
st_as_sf(coords = c("startLon", "startLat"), crs = 4326) %>%
st_filter(bb_sa_layer) %>%
st_transform(crs = 32610)
replica_trip_origin_links_fltrd
mapview(replica_trip_origin_links_fltrd)
data("study_area_seattle_network")
mapview(study_area_seattle_network)
data("replica_trip_origin_links")
replica_trip_origin_links_fltrd = replica_trip_origin_links %>%
st_as_sf(coords = c("startLon", "startLat"), crs = 4326) %>%
st_filter(study_area_seattle_network) %>%
st_transform(crs = 32610)
replica_trip_origin_links_fltrd
library(replicaToolkitR)
replica_trip_origin_links_gpkg = here(location, folder, 'replica_trip_origin_links') %>%
paste0(".gpkg") %>%  read_sf() %>%  st_transform(crs = 4326)
usethis::use_data(replica_trip_origin_links_gpkg, overwrite = TRUE)
here(location, folder, 'replica_trip_origin_links') %>%
paste0(".gpkg") %>%  read_sf() %>%  st_transform(crs = 4326)
here(location, folder, 'replica_trip_origin_links') %>%
paste0(".gpkg") %>%  read_sf()
here(location, folder, 'replica_trip_origin_links') %>%
paste0(".gpkg")
location
location = "data/req_dev"
folder = 'data_20230117_092037'
replica_trip_origin_links_gpkg = here(location, folder, 'replica_trip_origin_links') %>%
paste0(".gpkg") %>%  read_sf() %>%  st_transform(crs = 4326)
replica_trip_origin_links_gpkg
usethis::use_data(replica_trip_origin_links_gpkg, overwrite = TRUE)
replica_trip_origin_links = here(location, folder, 'replica_trip_origin_links') %>%
paste0(".csv") %>%  read.csv()
usethis::use_data(replica_trip_origin_links, overwrite = TRUE)
library(replicaToolkitR)
data("replica_trip_origin_links_gpkg")
replica_trip_origin_links_gpkg  %>%  head()
data("replica_trip_origin_links")
replica_trip_origin_links  %>%  head()
data("replica_trip_origin_links")
